#!/bin/sh
# Adapted from https://felix-kling.de/blog/2021/linux-toggle-dark-mode.html

# A specific mode (light/dark) can be forced from the command line
if [ -n "$1" ]; then
  nextbg=$1
else  # Switch to the opposite of current mode:
  current_link="$(readlink "$HOME/.config/waybar/style.css" 2>/dev/null)"
  case "$current_link" in
    *style-light.css) nextbg=dark ;;
    *style-dark.css) nextbg=light ;;
    *) nextbg=dark ;;
  esac
fi

# if [ -n "$1" ] && [ "$1" != "$nextbg" ]; then
#   # This is not that intuitive but if the requested mode is different from the
#   # next mode then the _current_ mode is the same as the requested one and there
#   # is nothing to do
#   exit 0
# fi


# Sway theme
ln -sf "$HOME/.config/sway/solarized-$nextbg" "$HOME/.config/sway/theme"
swaymsg reload

# Waybar theme
ln -sf "$HOME/.config/waybar/style-$nextbg.css" "$HOME/.config/waybar/style.css"
pkill -USR2 waybar 2>/dev/null || true

# Vim
echo "set background=$nextbg" > ~/.config/nvim/color

# Rofi (TODO: choose/create the themes)
if [ $nextbg = dark ]; then
  echo "-theme solarized_alternate" > ~/.config/rofi/theme
else
  echo "" > ~/.config/rofi/theme
fi

# For triggering dark themes in GTK apps. Requires `gnome-themes-extra` to be
# installed (for adwaita-dark). This is primarily for FF/Chrome.
if [ $nextbg = dark ]; then
  sed -i 's/"Adwaita.*"/"Adwaita-dark"/' ~/.config/xsettingsd/xsettingsd.conf
else
  sed -i 's/"Adwaita.*"/"Adwaita"/' ~/.config/xsettingsd/xsettingsd.conf
fi

# Reload

# Update Gtk apps. Potentially need to start xsettingsd if the first time:
# if systemctl --user is-active --quiet xsettingsd; then
#   killall -HUP xsettingsd  # Already running? Send signal to reload.
# else
#   systemctl --user start xsettingsd  # Not yet running? Start.
# fi
gsettings set org.gnome.desktop.interface color-scheme prefer-$nextbg
gsettings set org.gnome.desktop.interface gtk-theme Adwaita-$nextbg

# Update terminal emulator
kitty +kitten themes --reload-in=all "Solarized $(echo $nextbg | sed 's/dark/Dark Lucas/' | sed 's/light/Light/')"
# NeoVim watches the color file and reloads itself.
